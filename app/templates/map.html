{% extends "base.html" %}

{% block title %}–ö–∞—Ä—Ç–∞{% endblock %}

{% block content %}
<div id="map-container">
    <div id="map"></div>
    
    <div class="mood-info-panel">
        <div id="area-mood-info">
            <span id="area-mood-label"></span> <span id="area-mood"></span>
        </div>
        <div class="search-section">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏–∏...">
            <button id="search-btn">–ü–æ–∏—Å–∫</button>
        </div>
    </div>
    
    <div class="mobile-profile-btn-container">
        <a href="{{ url_for('profile') }}" class="mobile-profile-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
        </a>
    </div>
    
    <div id="floating-panel" class="floating-panel">
        <div class="drag-handle" id="drag-handle">
            <div class="drag-handle-line"></div>
        </div>
        <div class="panel-content">
            <div class="control-buttons">
                <button id="location-btn" class="control-btn" title="–ö –º–æ–µ–π –ª–æ–∫–∞—Ü–∏–∏">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                    </svg>
                    <span>–ö –º–æ–µ–π –ª–æ–∫–∞—Ü–∏–∏</span>
                </button>
                <button id="mood-btn" class="control-btn" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                    <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º</span>
                </button>
            </div>
            <div class="filter-content">
                <div class="filter-section">
                    <h4>–§–∏–ª—å—Ç—Ä—ã —ç–º–æ–¥–∑–∏</h4>
                    <div class="emoji-filter">
                        <button class="emoji-btn" data-emoji="üòä">üòä</button>
                        <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                        <button class="emoji-btn" data-emoji="üò°">üò°</button>
                        <button class="emoji-btn" data-emoji="üòé">üòé</button>
                        <button class="emoji-btn" data-emoji="ü•∞">ü•∞</button>
                        <button class="emoji-btn" data-emoji="üò¥">üò¥</button>
                        <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
                        <button class="emoji-btn" data-emoji="üò∑">üò∑</button>
                    </div>
                </div>
                <div class="filter-section">
                    <h4>–§–∏–ª—å—Ç—Ä—ã –≤—Ä–µ–º–µ–Ω–∏</h4>
                    <div class="time-filters">
                        <button class="time-filter-btn" data-minutes="10">10 –º–∏–Ω</button>
                        <button class="time-filter-btn" data-minutes="30">30 –º–∏–Ω</button>
                        <button class="time-filter-btn" data-minutes="60">1 —á–∞—Å</button>
                        <button class="time-filter-btn" data-minutes="120">2 —á–∞—Å–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="mood-panel" class="floating-panel" style="display: none;">
        <div class="panel-header">
            <h3>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º</h3>
        </div>
        <div class="panel-content">
            <div class="emoji-selector">
                <button class="emoji-btn" data-emoji="üòä">üòä</button>
                <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                <button class="emoji-btn" data-emoji="üò°">üò°</button>
                <button class="emoji-btn" data-emoji="üòé">üòé</button>
                <button class="emoji-btn" data-emoji="ü•∞">ü•∞</button>
                <button class="emoji-btn" data-emoji="üò¥">üò¥</button>
                <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
                <button class="emoji-btn" data-emoji="üò∑">üò∑</button>
            </div>
            <div class="mood-text">
                <textarea id="mood-text" placeholder="–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            </div>
            <div class="mood-suggestions">
                <h4>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h4>
                <div class="suggestion-chips">
                    <button class="suggestion-chip">–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!</button>
                    <button class="suggestion-chip">–¢—è–∂–µ–ª—ã–π –¥–µ–Ω—å</button>
                    <button class="suggestion-chip">–û—á–µ–Ω—å —Ä–∞–¥ —ç—Ç–æ–º—É</button>
                    <button class="suggestion-chip">–ù—É–∂–µ–Ω –æ—Ç–¥—ã—Ö</button>
                </div>
            </div>
            <div class="mood-actions">
                <button id="cancel-mood" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="submit-mood" class="btn btn-primary">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
        </div>
    </div>
    
    <a href="{{ url_for('profile') }}" class="profile-btn">–ü—Ä–æ—Ñ–∏–ª—å</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let map, userMarker, moodMarkers = {}, markerClusterGroup;
    let selectedEmoji = null;         // –í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    let userLocation = null;          // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
    let activeTimeFilter = null;      // –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
    let isUserArea = false;           // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ "–º–æ—è –ª–æ–∫–∞—Ü–∏—è" (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π)
    let isPanelExpanded = false;      // –§–ª–∞–≥ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π/—Å–≤–µ—Ä–Ω—É—Ç–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    
    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        initMap();             // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        setupEventListeners(); // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        fetchMoods();          // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        setupMobilePanel();    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –º–æ–±–∏–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Leaflet –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –µ—ë –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    function initMap() {
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        map = L.map('map', {
            zoomControl: false,        // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            attributionControl: false  // –û—Ç–∫–ª—é—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä—Å—Ç–≤–µ –∫–∞—Ä—Ç—ã
        }).setView([51.505, -0.09], 13); // –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å CARTO
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',  // –ü–æ–¥–¥–æ–º–µ–Ω—ã —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
            maxZoom: 19          // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
        }).addTo(map);
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
        L.control.zoom({
            position: 'topleft'  // –ü–æ–∑–∏—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        }).addTo(map);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
        // –ö–ª–∞—Å—Ç–µ—Ä—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç –±–ª–∏–∑–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–∏ –æ—Ç–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
        markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 50,               // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
            iconCreateFunction: createClusterIcon  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
        });
        map.addLayer(markerClusterGroup);  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        getUserLocation();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    function setupMobilePanel() {
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞–Ω–µ–ª—å—é
        const dragHandle = document.getElementById('drag-handle');
        const floatingPanel = document.getElementById('floating-panel');
        const filterContent = document.querySelector('.filter-content');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
        if (window.innerWidth <= 768) {  // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω–æ–µ (—à–∏—Ä–∏–Ω–∞ <= 768px)
            filterContent.style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            isPanelExpanded = false;               // –ü–∞–Ω–µ–ª—å —Å–≤–µ—Ä–Ω—É—Ç–∞
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ä—É—á–∫–µ –ø–∞–Ω–µ–ª–∏
        dragHandle.addEventListener('click', function() {
            togglePanelExpansion();  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
        });
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–≤–∞–π–ø–∞
        let startY = 0;
        let endY = 0;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è (–∑–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é Y)
        dragHandle.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });  // passive: true –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞ (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é Y)
        dragHandle.addEventListener('touchmove', function(e) {
            endY = e.touches[0].clientY;
        }, { passive: true });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è (–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞)
        dragHandle.addEventListener('touchend', function() {
            if (startY - endY > 50) { // –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö (–±–æ–ª–µ–µ 50 –ø–∏–∫—Å–µ–ª–µ–π)
                expandPanel();  // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            } else if (endY - startY > 50) { // –°–≤–∞–π–ø –≤–Ω–∏–∑
                collapsePanel();  // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {
            // –ü—Ä–∏ —à–∏—Ä–∏–Ω–µ –±–æ–ª—å—à–µ 768px, –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if (window.innerWidth > 768) {
                filterContent.style.display = 'block';
            } else if (!isPanelExpanded) {  // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞
                filterContent.style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            }
        });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ (—Å–≤–µ—Ä–Ω—É—Ç–∞ <-> —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞)
    function togglePanelExpansion() {
        if (isPanelExpanded) {
            collapsePanel();  // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º, –µ—Å–ª–∏ –±—ã–ª–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞
        } else {
            expandPanel();    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º, –µ—Å–ª–∏ –±—ã–ª–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞
        }
    }
    
    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    function expandPanel() {
        const filterContent = document.querySelector('.filter-content');
        filterContent.style.display = 'block';  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('floating-panel').classList.add('expanded');  // –î–æ–±–∞–≤–ª—è–µ–º CSS –∫–ª–∞—Å—Å
        isPanelExpanded = true;  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    }
    
    // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ - —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function collapsePanel() {
        const filterContent = document.querySelector('.filter-content');
        filterContent.style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('floating-panel').classList.remove('expanded');  // –£–¥–∞–ª—è–µ–º CSS –∫–ª–∞—Å—Å
        isPanelExpanded = false;  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
    // (–∫–ª–∞—Å—Ç–µ—Ä - —ç—Ç–æ –≥—Ä—É–ø–ø–∞ –±–ª–∏–∑–∫–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–¥–∞–ª–µ–Ω–∏–∏)
    function createClusterIcon(cluster) {
        const count = cluster.getChildCount();  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
        const markers = cluster.getAllChildMarkers();  // –í—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
        let positiveCount = 0;  // –°—á–µ—Ç—á–∏–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–º–æ–¥–∑–∏
        let negativeCount = 0;  // –°—á–µ—Ç—á–∏–∫ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —ç–º–æ–¥–∑–∏
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —ç–º–æ–¥–∑–∏
        markers.forEach(marker => {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ HTML –º–∞—Ä–∫–µ—Ä–∞
            const emoji = marker.options.icon.options.html.match(/>(.*?)<\/div>/)[1];
            if (['üòä', 'üòé', 'ü•∞'].includes(emoji)) {
                positiveCount++;  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö
            } else if (['üò¢', 'üò°', 'üò∑'].includes(emoji)) {
                negativeCount++;  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö
            }
        });
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö
        let clusterClass = 'marker-cluster';
        if (markers.length > 0) {
            const ratio = positiveCount / markers.length;  // –î–æ–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–º–æ–¥–∑–∏
            if (ratio >= 0.7) {  // –ï—Å–ª–∏ –±–æ–ª–µ–µ 70% –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö
                clusterClass += ' cluster-positive';
            } else if (ratio <= 0.3) {  // –ï—Å–ª–∏ –º–µ–Ω–µ–µ 30% –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö
                clusterClass += ' cluster-negative';
            } else {  // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
                clusterClass += ' cluster-neutral';
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞
        return L.divIcon({
            html: '<div class="cluster-icon">' + count + '</div>',  // HTML —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∞—Ä–∫–µ—Ä–æ–≤
            className: clusterClass,  // CSS –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            iconSize: L.point(40, 40)  // –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        });
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        document.getElementById('location-btn').addEventListener('click', function() {
            if (userLocation) {  // –ï—Å–ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–≤–µ—Å—Ç–Ω–æ
                if (isUserArea) {
                    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
                    isUserArea = false;
                    this.classList.remove('active');  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∏
                } else {
                    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    isUserArea = true;
                    this.classList.add('active');  // –í—ã–¥–µ–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    map.setView(userLocation, 15);  // –£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è 15
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç–µ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                fetchMoods();  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                updateMoodStats();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            } else {
                // –ï—Å–ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å
                getUserLocation();
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        map.on('moveend', function() {
            if (map.getZoom() < 13 || !map.getBounds().contains(userLocation)) {
                isUserArea = false;
                document.getElementById('location-btn').classList.remove('active');
            }
            updateMoodStats();
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        document.getElementById('mood-btn').addEventListener('click', function() {
            document.getElementById('floating-panel').style.display = 'none';
            document.getElementById('mood-panel').style.display = 'block';
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        document.getElementById('cancel-mood').addEventListener('click', function() {
            document.getElementById('mood-panel').style.display = 'none';
            document.getElementById('floating-panel').style.display = 'block';
            
            // –°–±—Ä–æ—Å –≤–≤–æ–¥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            document.querySelectorAll('#mood-panel .emoji-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('mood-text').value = '';
            selectedEmoji = null;
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏
        document.querySelectorAll('#mood-panel .emoji-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('#mood-panel .emoji-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedEmoji = this.getAttribute('data-emoji');
            });
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∏–ø–æ–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                document.getElementById('mood-text').value = this.innerText;
            });
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        document.getElementById('submit-mood').addEventListener('click', function() {
            submitMood();
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —ç–º–æ–¥–∑–∏
        document.querySelectorAll('.emoji-filter .emoji-btn').forEach(button => {
            button.addEventListener('click', function() {
                const wasActive = this.classList.contains('active');
                const emoji = this.getAttribute('data-emoji');
                
                if (wasActive) {
                    // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                    this.classList.remove('active');
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                    this.classList.add('active');
                }
                
                filterMoodsByEmoji();
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
        document.querySelectorAll('.time-filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                const wasActive = this.classList.contains('active');
                
                // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å–∏–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                document.querySelectorAll('.time-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (!wasActive) {
                    this.classList.add('active');
                    activeTimeFilter = parseInt(this.getAttribute('data-minutes'));
                } else {
                    activeTimeFilter = null;
                }
                
                filterMoodsByTime();
            });
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞
        document.getElementById('search-btn').addEventListener('click', function() {
            searchLocation(document.getElementById('search-input').value);
        });
        
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation(this.value);
            }
        });
    }
    
    function getUserLocation() {
        if ('geolocation' in navigator) {
            const locationTimeout = setTimeout(function() {
                handleLocationError('–¢–∞–π–º–∞—É—Ç: –∑–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.');
            }, 8000);
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    clearTimeout(locationTimeout);
                    
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (userMarker) {
                        userMarker.setLatLng(userLocation);
                    } else {
                        const userIcon = L.divIcon({
                            html: '<div class="user-marker"></div>',
                            className: '',
                            iconSize: [20, 20]
                        });
                        
                        userMarker = L.marker(userLocation, {
                            icon: userIcon,
                            zIndexOffset: 1000
                        }).addTo(map);
                    }
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    map.setView(userLocation, 15);
                    isUserArea = true;
                    
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏
                    updateMoodStats();
                },
                function(error) {
                    clearTimeout(locationTimeout);
                    let errorMessage;
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ —Å–ª—É–∂–±—ã –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                            break;
                        default:
                            errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                    }
                    
                    handleLocationError(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 60000
                }
            );
        } else {
            handleLocationError('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.');
        }
    }
    
    function handleLocationError(message) {
        alert(message);
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞)
        userLocation = [51.505, -0.09];
        map.setView(userLocation, 13);
    }
    
    function fetchMoods() {
        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è—Ö
        let url = '/api/moods';  // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API
        const params = new URLSearchParams();  // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ –∫ –∑–∞–ø—Ä–æ—Å—É, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
        if (activeTimeFilter) {
            const hours = activeTimeFilter / 60;  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—ã –≤ —á–∞—Å—ã –¥–ª—è API
            params.append('hours', hours);  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä hours –≤ –∑–∞–ø—Ä–æ—Å
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–∫–∞—Ü–∏–∏ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –≤—ã–±—Ä–∞–ª "–ö –º–æ–µ–π –ª–æ–∫–∞—Ü–∏–∏"
        if (isUserArea && userLocation) {
            params.append('lat', userLocation[0]);  // –®–∏—Ä–æ—Ç–∞
            params.append('lng', userLocation[1]);  // –î–æ–ª–≥–æ—Ç–∞
            params.append('radius', 10);  // –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ –≤ –∫–º (10 –∫–º)
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —ç–º–æ–¥–∑–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        const activeEmojiBtns = document.querySelectorAll('.emoji-filter .emoji-btn.active');
        const activeEmojis = Array.from(activeEmojiBtns).map(btn => btn.getAttribute('data-emoji'));
        if (activeEmojis.length > 0) {
            params.append('emojis', activeEmojis.join(','));  // –°–ø–∏—Å–æ–∫ —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º HTTP-–∑–∞–ø—Ä–æ—Å –∫ API
        fetch(url)
            .then(response => response.json())  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–≤–µ—Ç –≤ JSON
            .then(data => {
                displayMoods(data);  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
                updateMoodStats();   // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', error);
            });
    }
    
    function displayMoods(moods) {
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ
        
        // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
        markerClusterGroup.clearLayers();
        moodMarkers = {};  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ä–∫–µ—Ä–æ–≤
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        moods.forEach(mood => {
            const position = [mood.latitude, mood.longitude];  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
            // (—á—Ç–æ–±—ã —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –±—ã–ª–∏ –≤–∏–¥–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ)
            const offsetLat = (Math.random() - 0.5) * 0.002;  // –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —à–∏—Ä–æ—Ç—ã ¬±0,002¬∞
            const offsetLng = (Math.random() - 0.5) * 0.002;  // –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–æ–ª–≥–æ—Ç—ã ¬±0,002¬∞
            const displayPosition = [position[0] + offsetLat, position[1] + offsetLng];
            
            // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ —Å —ç–º–æ–¥–∑–∏
            const moodIcon = L.divIcon({
                html: '<div class="mood-marker">' + mood.emoji + '</div>',
                className: '',  // –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö CSS –∫–ª–∞—Å—Å–æ–≤
                iconSize: [30, 30]  // –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ 30x30 –ø–∏–∫—Å–µ–ª–µ–π
            });
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
            const marker = L.marker(displayPosition, {
                icon: moodIcon
            });
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º UTC –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const formattedDate = MoodMapUtils.formatDate(mood.timestamp);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ (popup) –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
            let popupContent = `<div class="mood-popup">${mood.emoji}`;
            if (mood.text) {
                popupContent += `<p>${mood.text}</p>`;  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            }
            popupContent += `<div class="mood-timestamp">${formattedDate}</div></div>`;
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∫ –º–∞—Ä–∫–µ—Ä—É
            marker.bindPopup(popupContent);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
            markerClusterGroup.addLayer(marker);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            moodMarkers[mood.id] = {
                marker: marker,
                data: mood
            };
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–π –æ–±–ª–∞—Å—Ç–∏
        updateMoodStats();
    }
    
    function submitMood() {
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —ç–º–æ–¥–∑–∏
        if (!selectedEmoji) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –∑–Ω–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!userLocation) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            getUserLocation();  // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            return;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const moodData = {
            emoji: selectedEmoji,  // –í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏
            text: document.getElementById('mood-text').value,  // –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            latitude: userLocation[0],  // –®–∏—Ä–æ—Ç–∞
            longitude: userLocation[1]  // –î–æ–ª–≥–æ—Ç–∞
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        fetch('/api/moods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(moodData)
        })
        .then(response => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
            if (!response.ok) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ');
            }
            return response.json();
        })
        .then(data => {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            document.getElementById('mood-panel').style.display = 'none';
            document.getElementById('floating-panel').style.display = 'block';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            document.querySelectorAll('#mood-panel .emoji-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('mood-text').value = '';
            selectedEmoji = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç–µ
            fetchMoods();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            alert('–í–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
        })
        .catch(error => {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        });
    }
    
    function filterMoods(emojis) {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –ø–æ —ç–º–æ–¥–∑–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
        // (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É, –∏—Å–ø–æ–ª—å–∑—É—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        
        // –û—á–∏—â–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ
        markerClusterGroup.clearLayers();
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º –º–∞—Ä–∫–µ—Ä–∞–º
        Object.values(moodMarkers).forEach(item => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏: —ç–º–æ–¥–∑–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –ò–õ–ò —ç–º–æ–¥–∑–∏ –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º
            if (!emojis || emojis.length === 0 || emojis.includes(item.data.emoji)) {
                markerClusterGroup.addLayer(item.marker);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        updateMoodStats();
    }
    
    function filterMoodsByEmoji() {
        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —ç–º–æ–¥–∑–∏
        const activeEmojiBtns = document.querySelectorAll('.emoji-filter .emoji-btn.active');
        const activeEmojis = Array.from(activeEmojiBtns).map(btn => btn.getAttribute('data-emoji'));
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        fetchMoods();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —ç–º–æ–¥–∑–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
        filterMoods(activeEmojis);
    }
    
    function filterMoodsByTime() {
        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —ç–º–æ–¥–∑–∏
        const activeEmojiBtns = document.querySelectorAll('.emoji-filter .emoji-btn.active');
        const activeEmojis = Array.from(activeEmojiBtns).map(btn => btn.getAttribute('data-emoji'));
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
        fetchMoods();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —ç–º–æ–¥–∑–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
        filterMoods(activeEmojis);
    }
    
    function isWithinTimeFilter(timestamp) {
        if (!activeTimeFilter) return true;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
        return MoodMapUtils.isWithinTimeFrame(timestamp, activeTimeFilter);
    }
    
    function searchLocation(query) {
        if (!query) return;
        
        // –ü—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–∏—Å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenStreetMap Nominatim
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const location = data[0];
                    map.setView([location.lat, location.lon], 13);
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≤ –ø–ª–∞–≤–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏
                    updateFloatingPanelInfo(location.display_name);
                    isUserArea = false;
                    
                    
                    // –ù–µ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ—Ç–∫–∏, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateMoodStats();
                } else {
                    alert('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            });
    }
    
    function updateFloatingPanelInfo(locationName) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–ª–∞–≤–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
        if (locationName) {
            const moodInfo = document.getElementById('area-mood').textContent.split(' ')[1];
            document.getElementById('area-mood').textContent = `${document.getElementById('area-mood').textContent.split(' ')[0]} ${moodInfo} - ${locationName}`;
        }
    }
    
    function updateAreaMoodLabel() {
        // const label = document.getElementById('area-mood-label');
        // if (isUserArea) {
        //     label.textContent = '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ –≤–∞—à–µ–º —Ä–∞–π–æ–Ω–µ:';
        // } else {
        //     label.textContent = '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ:';
        // }
    }
    
    function updateMoodStats() {
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã
        const bounds = map.getBounds();
        let positiveCount = 0;
        let totalCount = 0;
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —ç–º–æ–¥–∑–∏
        const activeEmojiBtns = document.querySelectorAll('.emoji-filter .emoji-btn.active');
        const activeEmojis = Array.from(activeEmojiBtns).map(btn => btn.getAttribute('data-emoji'));
        
        // –ü–æ–¥—Å—á–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏
        Object.values(moodMarkers).forEach(item => {
            const lat = item.data.latitude;
            const lng = item.data.longitude;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –∏ —ç–º–æ–¥–∑–∏
            const passesTimeFilter = !activeTimeFilter || MoodMapUtils.isWithinTimeFrame(item.data.timestamp, activeTimeFilter);
            const passesEmojiFilter = activeEmojis.length === 0 || activeEmojis.includes(item.data.emoji);
            
            if (passesTimeFilter && passesEmojiFilter && bounds.contains([lat, lng])) {
                totalCount++;
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
                const positiveEmojis = ['üòä', 'üòé', 'ü•∞'];
                if (positiveEmojis.includes(item.data.emoji)) {
                    positiveCount++;
                }
            }
        });
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –≤ –æ–±–ª–∞—Å—Ç–∏
        if (totalCount === 0) {
            document.getElementById('area-mood').textContent = '–í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è';
            return;
        }
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        let percentage = totalCount > 0 ? Math.round((positiveCount / totalCount) * 100) : 50;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        let moodEmoji;
        if (percentage >= 75) {
            moodEmoji = 'üòä';
        } else if (percentage >= 50) {
            moodEmoji = 'üôÇ';
        } else if (percentage >= 25) {
            moodEmoji = 'üòê';
        } else {
            moodEmoji = 'üòî';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        document.getElementById('area-mood').textContent = `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ: ${moodEmoji} ${percentage}%`;
    }
    
    // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≤–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏
    map.on('clusterclick', function(e) {
        const cluster = e.layer;
        const markers = cluster.getAllChildMarkers();
        if (markers.length > 0) {
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            const center = bounds.getCenter();
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        updateFloatingPanelInfo(data.display_name);
                        isUserArea = false;
                        
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏:', error);
                });
        }
    });
</script>
{% endblock %}

{% block extra_css %}
{% endblock %} 